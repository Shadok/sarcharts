var charts=[],infos={},lineColors=["#c0392b","#e74c3c","#9b59b6","#8e44ad","#2980b9","#3498db","#1abc9c","#16a085","#27ae60","#2ecc71","#f1c40f","#f39c12","#e67e22","#d35400","#bdc3c7","#95a5a6","#7f8c8d","#34495e","#2c3e50"],menuActive="start";function addAlert(e,a){var t='<div class="alert alert-dismissible alert-'+e+'"><button type="button" class="close" data-dismiss="alert">&times;</button>'+a+"</div>";$("#alert").html(t),$("#alert").removeClass("d-none"),$("html, body").animate({scrollTop:0},1500)}function addMenuEntry(e,a,t){$("#menu-"+a).next("div.dropdown-menu").append('<a class="dropdown-item" data-anchor="a-'+t+'">'+e+"</a>")}function displayInformations(){infos.restart?infos.restart="Please note, the server has restarted at "+infos.restart_time+" !":infos.restart="",$("#infos").html("SAR for the "+infos.server.os+" server "+infos.server.hostname+" ("+infos.server.kernel+") from the "+infos.server.date+". "+infos.restart)}function extractSarData(e,t,s,n){n=n||0;var r={labels:[],values:{}};return 0==(s=s||"").length&&0==n&&(r.values=[]),$.each(e,function(e,a){r.labels.push(e),0==s.length?1==n?$.each(a,function(e,a){e in r.values||(r.values[e]=[]),r.values[e].push(a[t])}):r.values.push(a[t]):(s in r.values||(r.values[s]=[]),r.values[s].push(a[s][t]))}),r}function generatePDF(){var l=new jsPDF({compress:!0,putOnlyUsedFonts:!0,unit:"px"});l.setProperties({title:"SAR graphs of "+infos.server.hostname+" for the "+infos.server.date,subject:"SAR for the "+infos.server.os+" server "+infos.server.hostname+" ("+infos.server.kernel+") from the "+infos.server.date+". "+infos.restart,author:"SAR Charts : https://github.com/Shadok/sarcharts",keywords:"",creator:"Shadok"});var e=l.internal.pageSize.width,a=l.internal.pageSize.height,d=e-50,c=a-50;l.setFontType("bold"),l.setFontSize(16),l.text("SAR Charts",25,25),l.setFontSize(22),l.text("SAR graphs for "+infos.server.hostname,e/2,a/2-33,{align:"center"}),l.setFontSize(20),l.text(infos.server.os+" - "+infos.server.kernel+" - "+infos.server.date,e/2,a/2+33,{align:"center"}),l.setFontSize(16),l.text("https://github.com/Shadok/sarcharts",e-25,a-25,{align:"right"}),l.setFontSize(22),l.addPage();var u=25;$("img.selected").each(function(e,a){var t=$(this).next("canvas"),s=t.attr("id"),n=t.innerHeight(),r=t.innerWidth();if(d<r){var o=d/r;r*=o,n*=o}25+c<u+n&&(l.addPage(),u=25);var i=(t=document.querySelector("#"+s)).toDataURL("image/png",1);10<i.length&&(l.addImage(i,"PNG",25,u,r,n),u+=n+15)}),l.setFontType("normal"),l.setFontSize(10);var t=l.internal.getNumberOfPages();for(i=2;i<=t;i++)l.setPage(i),l.text(e-30,a-10,l.internal.getCurrentPageInfo().pageNumber+"/"+t);l.output("dataurlnewwindow")}function getGraphData(s,n,e,r){e=e||[],r=r||"";if(void 0===n)return!1;var o="";n.config&&n.config.limit&&(o=n.config.limit);var i=n.config.category.toLowerCase();0==r.length&&(r=i);var l="";return 0<e.length?$.each(e,function(e,t){$.each(n.columns,function(e,a){t==a&&(title=lang.titles[i][s][a],graphData(a,l=extractSarData(n.data,e,o,n.config.multiple),title,r,n.config.multiple))})}):$.each(n.columns,function(e,a){title=lang.titles[i][s][a],graphData(a,l=extractSarData(n.data,e,o,n.config.multiple),title,r,n.config.multiple)}),l}function graphData(e,a,t,s,n){n=n||0;var r=s+"-"+e.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"_");$("#graph-"+s).append('<div class="graph" id="a-'+r+'"><img class="icon-pdf unselected" src="./images/pdf_unselected.png"><canvas id="'+r+'" class="rounded"></canvas></div>'),addMenuEntry(e,s,r);var o=3,i=[];if(0==n){var l=lineColors[Math.floor(Math.random()*lineColors.length)];i=[{label:e,data:a.values,fill:!1,borderColor:l}]}else $.each(a.values,function(e,a){var t=lineColors[Math.floor(Math.random()*lineColors.length)];i.push({label:e,data:a,fill:!1,borderColor:t})}),(o=3-i.length/100)<.8&&(o=.8);var d="HH:mm",c=new Chart($("#"+r),{data:{labels:a.labels,datasets:i},options:{aspectRatio:o,plugins:{zoom:{zoom:{enabled:!0,drag:{animationDuration:1e3,borderColor:"rgba(255,255,255,0.3)",borderWidth:5,backgroundColor:"rgb(255,255,255)"},mode:"x",speed:.05,onZoom:function(e){updateAllCharts(e.chart.options.scales.xAxes[0].ticks.min,e.chart.options.scales.xAxes[0].ticks.max)}},pan:{enabled:!0,mode:"x",onPan:function(e){updateAllCharts(e.chart.options.scales.xAxes[0].ticks.min,e.chart.options.scales.xAxes[0].ticks.max)}}}},scales:{yAxes:[{scaleLabel:{display:!0,labelString:e}}],xAxes:[{type:"time",time:{parser:d,tooltipFormat:d,displayFormats:{second:d,minute:d,hour:d}},scaleLabel:{display:!0,labelString:"Heure"},ticks:{autoSkip:!0,autoSkipPadding:50}}]},title:{display:!0,text:t}},type:"line"});charts.push(c)}function graphResume(e,a){switch(a){case"AIX":getGraphData(a,e["%usr"],["%usr","%sys","%wio"],"resume"),getGraphData(a,e.slots,["slots","odio/s"],"resume");break;case"Linux":getGraphData(a,e["runq-sz"],["ldavg-1","ldavg-5","ldavg-15"],"resume"),getGraphData(a,e.CPU,["%user","%usr","%nice","%iowait"],"resume"),getGraphData(a,e.kbmemfree,["%memused","%swpused"],"resume"),getGraphData(a,e.DEV,["%util"],"resume");break;case"Solaris":getGraphData(a,e["%usr"],["%usr","%sys","%wio"],"resume"),getGraphData(a,e.freemem,["freemem","freeswap"],"resume")}}function initGraph(e){$(".nav-graph").removeClass("d-none"),$(".nav-pdf").removeClass("d-none"),$("#start").addClass("d-none"),$("#menu-start").parent().removeClass("active"),$("#menu-resume").parent().addClass("active"),$("#graph-resume").removeClass("d-none"),menuActive="resume";var t=(infos=e.infos).server.family;displayInformations(),graphResume(e.data,t),$.each(e.data,function(e,a){getGraphData(t,a)}),$("div.dropdown-menu").each(function(e,a){$(this).html().length<10&&$(this).parent("li.nav-graph").addClass("d-none")})}function removeAlert(){$("#alert").addClass("d-none")}function resetAllCharts(){charts.forEach(function(e){e.chart.options.scales.xAxes[0].ticks.min=null,e.chart.options.scales.xAxes[0].ticks.max=null,e.update()})}function updateAllCharts(a,t){charts.forEach(function(e){e.chart.options.scales.xAxes[0].ticks.min=a,e.chart.options.scales.xAxes[0].ticks.max=t,e.update()})}$(document).ready(function(){$("#submit-manual").click(function(e){e.preventDefault(),removeAlert(),$("#sarfile-manual-loading").removeClass("d-none");var a=$("#sarfile-upload").prop("files")[0],t=new FormData;t.append("file",a),$.ajax({url:"./lib/uploadSA.php",dataType:"json",cache:!1,contentType:!1,processData:!1,data:t,type:"POST"}).fail(function(){$("#sarfile-manual-loading").addClass("d-none"),addAlert("danger","Unable to load the given text file!")}).done(function(e){0==e.success?($("#sarfile-manual-loading").addClass("d-none"),addAlert("danger",e.error)):(initGraph(e),$("#sarfile-manual-loading").addClass("d-none"))})}),$(".nav-link[id]").click(function(e){e.preventDefault(),menuId=$(this).attr("id"),"menu-pdf"==menuId?0<$("img.selected").length?(removeAlert(),generatePDF()):addAlert("warning","Please select at least one graph to export in PDF!"):($("#menu-"+menuActive).parent().removeClass("active"),$(this).parent().addClass("active"),$("#graph-"+menuActive).addClass("d-none"),"start"!=(menuActive=menuId.replace("menu-",""))?($("html, body").animate({scrollTop:0},1500),$("#graph-"+menuActive).removeClass("d-none")):($(".nav-graph").addClass("d-none"),$(".nav-pdf").addClass("d-none"),$("div.dropdown-menu").empty(),$("#start").removeClass("d-none"),$("[id^=graph-]").html(""),$("#infos").html("You can zoom on the graphs by selecting an area of one of them, then unzoom with a double-click."),charts=[]))}),$("body").on("click",".dropdown-item",function(e){e.preventDefault();var a=$(this).attr("data-anchor"),t=$(this).parent("div.dropdown-menu").attr("aria-labelledby").replace("menu-","");$("#menu-"+menuActive).parent().removeClass("active"),$("#menu-"+t).parent().addClass("active"),$("#graph-"+menuActive).addClass("d-none"),menuActive=t,$("#graph-"+menuActive).removeClass("d-none"),$("html, body").animate({scrollTop:$("#"+a).offset().top},1500)}),$("[id^=graph-]").dblclick(function(){resetAllCharts()}),$("body").on("click","img.unselected",function(e){$(this).removeClass("unselected"),$(this).addClass("selected"),$(this).attr("src","./images/pdf_selected.png")}),$("body").on("click","img.selected",function(e){$(this).removeClass("selected"),$(this).addClass("unselected"),$(this).attr("src","./images/pdf_unselected.png")})});
